import React, { useState, useEffect, useMemo } from 'react';
import { FileText, Printer, Download, Calendar, Loader2 } from 'lucide-react';
import { useSettings } from '../../context/SettingsContext';

// Firebase
import { db } from '../../firebase/config';
import { collection, onSnapshot, query, orderBy } from 'firebase/firestore';

const Reports = () => {
  const { t, lang } = useSettings(); // ğŸ‘ˆ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø©
  const [reportType, setReportType] = useState('inventory');
  const [medicines, setMedicines] = useState([]);
  const [loading, setLoading] = useState(true);

  // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  useEffect(() => {
    const q = query(collection(db, "medicines"), orderBy("name"));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setMedicines(data);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 2. ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const reportData = useMemo(() => {
    if (reportType === 'shortage') {
      return medicines.filter(item => Number(item.stock) < 50);
    }
    return medicines;
  }, [reportType, medicines]);

  // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  const handlePrint = () => {
    window.print();
  };

  // ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… (Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©)
  const today = new Date().toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const refNumber = Math.floor(Math.random() * 10000);

  // Ù†ØµÙˆØµ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø© (ÙŠÙ…ÙƒÙ† Ù†Ù‚Ù„Ù‡Ø§ Ù„Ù…Ù„Ù Ø§Ù„ØªØ±Ø¬Ù…Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹)
  const reportTexts = {
    header: lang === 'ar' ? "Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ù…ØµØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" : "Arab Republic of Egypt",
    ministry: lang === 'ar' ? "ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø³ÙƒØ§Ù†" : "Ministry of Health",
    sector: lang === 'ar' ? "Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªÙ…ÙˆÙŠÙ† Ø§Ù„Ø·Ø¨ÙŠ (ØªØ±ÙŠØ§Ù‚)" : "Medical Supply Sector (Tiryaq)",
    title: reportType === 'inventory' 
      ? (lang === 'ar' ? 'ÙƒØ´Ù Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†' : 'Inventory Report') 
      : (lang === 'ar' ? 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙˆØ§Ù‚Øµ Ø§Ù„Ø­Ø±Ø¬Ø©' : 'Critical Shortage Report'),
    subjectTitle: lang === 'ar' ? "Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:" : "Subject:",
    subjectBody: reportType === 'inventory'
      ? (lang === 'ar' ? 'ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ Ø¨ÙŠØ§Ù† ØªÙØµÙŠÙ„ÙŠ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¨Ø§Ù„Ù…Ø®Ø§Ø²Ù† Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®Ù‡.' : 'Below is a detailed statement of all available stock in warehouses to date.')
      : (lang === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¥Ø­Ø§Ø·Ø© Ø¨ÙˆØ¬ÙˆØ¯ Ø¹Ø¬Ø² ÙÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…ÙˆØ¶Ø­Ø© Ø£Ø¯Ù†Ø§Ù‡ØŒ ÙˆÙ†ÙˆØµÙŠ Ø¨Ø³Ø±Ø¹Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯.' : 'Please note the shortage in the items listed below; urgent supply is recommended.'),
    recTitle: lang === 'ar' ? "ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù„ÙŠ:" : "Automated Recommendations:",
    recSafe: lang === 'ar' ? "Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙŠ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¢Ù…Ù†Ø©." : "Stock levels are safe.",
    recDanger: lang === 'ar' ? `ÙŠÙˆØ¬Ø¯ (${reportData.filter(i => i.stock < 50).length}) Ø£ØµÙ†Ø§Ù ØªØ­Øª Ø­Ø¯ Ø§Ù„Ø®Ø·Ø±.` : `There are (${reportData.filter(i => i.stock < 50).length}) items below safety level.`,
    footerNote: lang === 'ar' ? "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¢Ù„ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… ØªØ±ÙŠØ§Ù‚." : "Automatically generated by Tiryaq System.",
    signStore: lang === 'ar' ? "Ø£Ù…ÙŠÙ† Ø§Ù„Ù…Ø®Ø²Ù†" : "Store Keeper",
    signManager: lang === 'ar' ? "Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰" : "Hospital Manager"
  };

  if (loading) return <div className="flex justify-center p-20"><Loader2 className="animate-spin text-blue-600" size={40} /></div>;

  return (
    <div className="space-y-8 animate-fade-in pb-10">
      
      {/* Ø§Ù„Ù‡ÙŠØ¯Ø± (ÙŠØ®ØªÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) */}
      <div className="flex justify-between items-center print:hidden">
        <div>
          <h1 className="text-3xl font-bold text-gray-800 dark:text-white mb-2">
            {t.reports} ğŸ“„
          </h1>
          <p className="text-gray-500">{lang === 'ar' ? 'Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠØ©' : 'Extract Official Documents'}</p>
        </div>
        <button 
          onClick={handlePrint}
          className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 transition-all flex items-center gap-2"
        >
          <Printer size={20} />
          {lang === 'ar' ? 'Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±' : 'Print Report'}
        </button>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 print:block">
        
        {/* 1. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (ØªØ®ØªÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©) */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-gray-100 dark:border-slate-700 shadow-sm h-fit print:hidden">
          <h3 className="font-bold text-lg text-gray-800 dark:text-white mb-4">{lang === 'ar' ? 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±' : 'Report Settings'}</h3>
          
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">{lang === 'ar' ? 'Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±' : 'Report Type'}</label>
              <select 
                value={reportType} onChange={(e) => setReportType(e.target.value)}
                className="w-full p-2 rounded-lg bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 text-gray-800 dark:text-white outline-none"
              >
                <option value="inventory">{lang === 'ar' ? 'Ø¬Ø±Ø¯ Ø´Ø§Ù…Ù„' : 'Full Inventory'}</option>
                <option value="shortage">{lang === 'ar' ? 'Ø§Ù„Ù†ÙˆØ§Ù‚Øµ' : 'Shortages'}</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">{lang === 'ar' ? 'Ø§Ù„ØªØ§Ø±ÙŠØ®' : 'Date'}</label>
              <div className="flex items-center gap-2 bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 p-2 rounded-lg text-gray-800 dark:text-white">
                <Calendar size={18} className="text-gray-400" />
                <span>{today}</span>
              </div>
            </div>

            <div className="pt-4 border-t border-gray-100 dark:border-slate-700">
              <p className="text-xs text-gray-500 mb-2">{lang === 'ar' ? `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${reportData.length}` : `Records count: ${reportData.length}`}</p>
              <button onClick={handlePrint} className="w-full py-2 rounded-lg border border-blue-600 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors font-bold flex items-center justify-center gap-2">
                <Download size={18} />
                {lang === 'ar' ? 'ØªØ­Ù…ÙŠÙ„ PDF' : 'Download PDF'}
              </button>
            </div>
          </div>
        </div>

        {/* 2. ÙˆØ±Ù‚Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (A4) */}
        <div className="lg:col-span-2 print:w-full print:col-span-3">
          <div className="bg-white text-black p-12 rounded-xl shadow-2xl min-h-[1123px] w-full max-w-[794px] mx-auto relative print:shadow-none print:m-0 print:w-full print:p-0" dir={lang === 'ar' ? 'rtl' : 'ltr'}>
            
            {/* ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± */}
            <div className="border-b-2 border-black pb-4 mb-8 flex justify-between items-start">
              <div>
                <h2 className="text-xl font-bold mb-1">{reportTexts.header}</h2>
                <h3 className="text-lg">{reportTexts.ministry}</h3>
                <p className="text-sm text-gray-600">{reportTexts.sector}</p>
              </div>
              <div className={`text-${lang === 'ar' ? 'left' : 'right'}`}>
                <h1 className="text-2xl font-bold text-blue-800 mb-1 uppercase">
                    {reportTexts.title}
                </h1>
                <p className="text-sm text-gray-600">Ref: #{refNumber}</p>
                <p className="text-sm text-gray-600">{today}</p>
              </div>
            </div>

            {/* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */}
            <div className="mb-8">
              <h4 className="text-lg font-bold border-b border-gray-300 pb-2 mb-4">
                {reportTexts.subjectTitle} <span className="font-normal text-base">{reportTexts.title}</span>
              </h4>
              <p className="text-justify leading-relaxed mb-6 text-sm">
                {reportTexts.subjectBody}
              </p>

              {/* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */}
              <table className="w-full border-collapse border border-black text-center text-sm mb-6">
                <thead className="bg-gray-200 font-bold">
                  <tr>
                    <th className="border border-black p-2 w-10">#</th>
                    <th className={`border border-black p-2 ${lang === 'ar' ? 'text-right' : 'text-left'}`}>{t.table.name}</th>
                    <th className="border border-black p-2">{t.table.category}</th>
                    <th className="border border-black p-2">{t.table.stock}</th>
                    <th className="border border-black p-2">{t.table.status}</th>
                  </tr>
                </thead>
                <tbody>
                  {reportData.length > 0 ? (
                    reportData.map((item, index) => (
                      <tr key={item.id}>
                        <td className="border border-black p-2">{index + 1}</td>
                        <td className={`border border-black p-2 font-bold ${lang === 'ar' ? 'text-right' : 'text-left'}`}>{item.name}</td>
                        <td className="border border-black p-2">{item.category}</td>
                        <td className={`border border-black p-2 font-bold ${Number(item.stock) < 50 ? 'text-red-600' : ''}`}>
                          {item.stock}
                        </td>
                        <td className="border border-black p-2 text-xs">
                           {Number(item.stock) === 0 ? t.status.out : Number(item.stock) < 50 ? t.status.low : t.status.good}
                        </td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td colSpan="5" className="border border-black p-4 text-gray-500">{t.noData}</td>
                    </tr>
                  )}
                </tbody>
              </table>

              {/* Ø§Ù„ØªÙˆØµÙŠØ§Øª */}
              <div className="bg-gray-50 p-4 border border-gray-200 rounded text-sm print:bg-white print:border-black">
                <strong>ğŸ’¡ {reportTexts.recTitle}</strong>
                <ul className={`list-disc mt-2 space-y-1 ${lang === 'ar' ? 'mr-5' : 'ml-5'}`}>
                  {reportType === 'shortage' || reportData.some(i => Number(i.stock) < 50) ? (
                    <>
                      <li className="text-red-600 font-bold">{reportTexts.recDanger}</li>
                      <li>{lang === 'ar' ? 'ÙŠØ±Ø¬Ù‰ ØªÙˆØ¬ÙŠÙ‡ Ø£ÙˆØ§Ù…Ø± ØªÙˆØ±ÙŠØ¯ ÙÙˆØ±ÙŠØ©.' : 'Immediate supply orders recommended.'}</li>
                    </>
                  ) : (
                    <li className="text-green-600">{reportTexts.recSafe}</li>
                  )}
                  <li className="text-gray-500 italic">{reportTexts.footerNote}</li>
                </ul>
              </div>
            </div>

            {/* Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª */}
            <div className="flex justify-between mt-24 pt-8 break-inside-avoid">
              <div className="text-center">
                <p className="font-bold mb-6">{reportTexts.signStore}</p>
                <p className="text-gray-400">....................</p>
              </div>
              <div className="text-center">
                <p className="font-bold mb-6">{reportTexts.signManager}</p>
                <p className="text-gray-400">....................</p>
              </div>
              
              {/* Ø§Ù„Ø®ØªÙ… */}
              <div className={`absolute bottom-20 ${lang === 'ar' ? 'left-20' : 'right-20'} opacity-20 -rotate-12 border-4 border-blue-800 text-blue-800 p-4 rounded-full font-bold text-xl print:opacity-50`}>
                TIRYAQ SYSTEM
                <br />
                OFFICIAL DOC
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  );
};

export default Reports;